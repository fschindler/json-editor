"use strict";(self.webpackChunkjson_editor=self.webpackChunkjson_editor||[]).push([[7433],{"./packages/rje-code-widgets/src/lib/jsonwidget/JsonWidget.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{jb:()=>JsonWidget,N8:()=>JsonWidgetPlugin});var jsx_runtime=__webpack_require__("./node_modules/react/jsx-runtime.js"),index_modern=__webpack_require__("./packages/rje-code-widgets/node_modules/markdown-to-jsx/dist/index.modern.js"),react=__webpack_require__("./node_modules/react/index.js"),esm=__webpack_require__("./node_modules/@uiw/react-codemirror/esm/index.js"),dist=__webpack_require__("./node_modules/@codemirror/lang-json/dist/index.js"),src=__webpack_require__("./packages/react-json-editor/src/index.ts"),client=__webpack_require__("./node_modules/react-dom/client.js"),dist_module=__webpack_require__("./node_modules/json-schema-library/dist/module/index.js"),jsonPointer=__webpack_require__("./node_modules/@sagold/json-pointer/dist/jsonPointer.js"),jsonPointer_default=__webpack_require__.n(jsonPointer),language_dist=__webpack_require__("./node_modules/@codemirror/language/dist/index.js");function getValue(doc,cursor){return doc.sliceString(cursor.from,cursor.to)}function getPropertyName(doc,cursor){if("Property"!==cursor.node.name)throw new Error(`Cannot resolve property name of none property: ${cursor.node.name}`);const propertyCursor=cursor.node.cursor();return propertyCursor.next(),doc.sliceString(propertyCursor.from+1,propertyCursor.to-1)}function isWithinNode(cursor,position){return cursor.from<=position&&position<=cursor.to}const STEP_INTO_NODE=["JsonText","Property","Object","Array"];function getJsonPointerFromPosition(state,position){const tree=(0,language_dist.qz)(state);return getJsonPointerFromCursor(state.doc,tree.cursor(),position)}function getJsonPointerFromCursor(doc,cursor,from,pointer=""){const nodeType=cursor.node.name;if(isWithinNode(cursor,from))return STEP_INTO_NODE.includes(nodeType)?(cursor.next(),getJsonPointerFromCursor(doc,cursor,from,pointer)):"PropertyName"===nodeType?{pointer,cursor,location:"property"}:{pointer,cursor,location:"value"};const isArray="["===cursor.node.name;let childIndex=0;for(;cursor.nextSibling();){if(isWithinNode(cursor,from)){if("Property"===cursor.node.name){return getJsonPointerFromCursor(doc,cursor,from,`${pointer}/${getPropertyName(doc,cursor)}`)}return getJsonPointerFromCursor(doc,cursor,from,isArray?`${pointer}/${childIndex}`:pointer)}childIndex++}return"}"===cursor.node.name?{pointer,cursor,location:"object"}:"]"===cursor.node.name?{pointer,cursor,location:"array"}:{pointer,cursor,location:"outside"}}const dom=document.createElement("div"),root=(0,client.s)(dom);function insertValue(view,completion,from,to){let end=to;view.state.doc.sliceString(from,to).startsWith('"')&&(end+=1),view.dispatch({selection:{anchor:from+completion.label.length,head:from+completion.label.length},changes:[{from,to:end,insert:completion.label}]})}function getValueCompletions(schema){return Array.isArray(schema.enum)?schema.enum.map((v=>({label:JSON.stringify(v),type:"text",info:()=>renderInfo(schema),detail:schema.type??typeof v,apply:insertValue}))):schema.const?[{label:JSON.stringify(schema.const),type:"text",info:()=>renderInfo(schema),detail:schema.type??typeof schema.const,apply:insertValue}]:[]}const jsonSchemaCompletion=(draft,schema)=>async function(context){const resolvedCursor=getJsonPointerFromPosition(context.state,context.pos),{location}=resolvedCursor;return COMPLETION[location]?COMPLETION[location](draft,schema,context,resolvedCursor):null},COMPLETION={array:(draft,schema,context,{pointer})=>{const parentSchema=draft.getSchema({pointer,data:getData(context),schema});if(!parentSchema||(0,dist_module.yI)(parentSchema))return console.log(`failed resolving completion of 'array' on ${pointer}`,parentSchema),null;if(Array.isArray(parentSchema.items)){const itemsSchema=parentSchema.items;return{from:context.pos,options:itemsSchema.map((schema=>{const value=draft.getTemplate(void 0,schema);return{label:JSON.stringify(value),type:"text",info:()=>renderInfo(schema),detail:schema.type,apply:JSON.stringify(value)}}))}}if(parentSchema.items.oneOf){const options=draft.getChildSchemaSelection(0,parentSchema);return(0,dist_module.yI)(options)?null:{from:context.pos,options:options.map(((s,index)=>({label:s.title||`${index+1}. item (no title defined)`,type:"text",info:()=>renderInfo(s),detail:s.type,apply:JSON.stringify(draft.getTemplate(void 0,s))})))}}if(function isObject(value){return"[object Object]"===Object.prototype.toString.call(value)}(parentSchema.items)){const itemSchema=parentSchema.items;return{from:context.pos,options:getValueCompletions(itemSchema)}}return null},object:(draft,schema,context,{pointer})=>{const data=getData(context),targetData=(0,jsonPointer.get)(data,pointer)??{},parentSchema=draft.getSchema({pointer,data,schema});if(!parentSchema||(0,dist_module.yI)(parentSchema))return console.log(`failed resolving completion of 'object' on ${pointer}`,parentSchema),null;const options=[];return Object.keys(parentSchema.properties).forEach((prop=>{if(void 0!==targetData[prop])return;const propertySchema=parentSchema.properties[prop];let initialValue;initialValue=propertySchema.const?propertySchema.const:propertySchema.enum?propertySchema.enum[0]:draft.getTemplate(void 0,propertySchema),options.push({label:`"${prop}"`,type:"keyword",info:()=>renderInfo(propertySchema),detail:propertySchema.type,apply:`"${prop}": ${JSON.stringify(initialValue)}`})})),{from:context.pos,options}},outside:(draft,schema,context,{pointer})=>{const data=getData(context),targetSchema=draft.getSchema({pointer,data,schema});if(!targetSchema||(0,dist_module.yI)(targetSchema))return console.log(`failed resolving completion of 'outside' on ${pointer}`,targetSchema),null;return{from:context.pos,options:getValueCompletions(targetSchema)}},property:(draft,schema,context,{pointer,cursor})=>{const parentPointer=function getParentPointer(pointer){const fragments=(0,jsonPointer.split)(pointer);return fragments.pop(),(0,jsonPointer.join)(fragments)}(pointer),data=getData(context),targetData=(0,jsonPointer.get)(data,pointer)??{},parentSchema=draft.getSchema({pointer:parentPointer,data,schema});if(!parentSchema||(0,dist_module.yI)(parentSchema))return console.log(`failed resolving completion of 'property' on ${pointer}`,parentSchema),null;const options=[];return Object.keys(parentSchema.properties).forEach((prop=>{if(void 0!==targetData[prop])return;const propertySchema=parentSchema.properties[prop];options.push({label:`${prop}`,type:"keyword",info:()=>renderInfo(propertySchema),detail:propertySchema.type})})),{from:cursor.from+1,options}},value:(draft,schema,context,{pointer,cursor})=>{const data=getData(context),schemaOfLocation=draft.getSchema({pointer,data,schema});if(!schemaOfLocation||(0,dist_module.yI)(schemaOfLocation))return console.log(`failed resolving completion of 'value' on ${pointer}`,schemaOfLocation),null;if(schemaOfLocation.items&&schemaOfLocation.items.oneOf){const options=draft.getChildSchemaSelection(0,schemaOfLocation);return(0,dist_module.yI)(options)?null:{from:context.pos,options:options.map(((s,index)=>({label:s.title||`${index+1}. item (no title defined)`,type:"text",info:()=>renderInfo(s),detail:s.type,apply:JSON.stringify(draft.getTemplate(void 0,s))})))}}return{from:cursor.from,options:getValueCompletions(schemaOfLocation)}}};function renderInfo(schema){return null==schema||null==schema.title&&null==schema.description?null:(root.render((0,jsx_runtime.jsxs)("div",{className:"rje-tooltip rje-tooltip--jsonschema",children:[schema.title&&(0,jsx_runtime.jsx)("h1",{children:schema.title}),schema.description&&(0,jsx_runtime.jsx)(index_modern.ZP,{children:schema.description})]})),dom)}function getData(context){try{return JSON.parse(context.state.doc.toString())}catch(e){return}}function buildJsonPointerMap(doc,cursor,pointer="#",map={}){const nodeType=cursor.node.name;if("JsonText"===nodeType)return cursor.next(),buildJsonPointerMap(doc,cursor,pointer,map);if("Object"===nodeType){for(cursor.next();cursor.nextSibling();)if("Property"===cursor.node.name){const location={node:cursor.node,from:cursor.from,to:cursor.to},propertyCursor=cursor.node.cursor();propertyCursor.next();const jsonName=getValue(doc,propertyCursor);map[`${pointer}/${JSON.parse(jsonName)}`]=location,propertyCursor.next(),"Object"!==propertyCursor.node.name&&"Array"!==propertyCursor.node.name||buildJsonPointerMap(doc,propertyCursor,`${pointer}/${JSON.parse(jsonName)}`,map)}return map}if("Array"===nodeType){cursor.next();let index=0;for(;cursor.nextSibling();)"]"!==cursor.node.name&&(map[`${pointer}/${index}`]={node:cursor.node,from:cursor.from,to:cursor.to},"Object"!==cursor.node.name&&"Array"!==cursor.node.name||buildJsonPointerMap(doc,cursor,`${pointer}/${index}`,map),index++);return map}return console.error("Unparsed node",cursor.node.name||cursor),{}}const jsonLintPropertyDuplicates_STEP_INTO_NODE=["JsonText","Property","PropertyName","Object","Array"];function jsonLintPropertyDuplicates(doc,cursor,duplicates=[]){const nodeType=cursor.node.name;if(jsonLintPropertyDuplicates_STEP_INTO_NODE.includes(nodeType))return cursor.next(),jsonLintPropertyDuplicates(doc,cursor,duplicates);if("{"===nodeType||"["===nodeType){const properties={};for(;cursor.nextSibling()&&"}"!==cursor.node.name;){if("Property"===cursor.node.name){const name=getPropertyName(doc,cursor),propertyNameCursor=cursor.node.cursor();propertyNameCursor.next();const propertyInfo={from:propertyNameCursor.from,to:propertyNameCursor.to,severity:"error",message:`Duplicated property '${name}'. Remove duplication as all previous properties with same name will removed in export.`};properties[name]&&duplicates.push(properties[name]),properties[name]=propertyInfo}duplicates.push(...jsonLintPropertyDuplicates(doc,cursor.node.cursor()))}}return duplicates}function getPropertyNameCursor(node){if("Property"===node.name){const cursor=node.cursor();return cursor.next(),cursor}}function jsonSchemaLinter(editor,schema){const rootSchema=schema?.$ref?editor.draft.getSchema():schema,draft=new dist_module.nu(editor.draft.config,rootSchema),localSchema=draft.compileSchema(schema);return async function(view){const jsonLintResult=(0,dist.ap)()(view);return jsonLintResult.length>0?jsonLintResult:function runJsonSchemaLinter(draft,schema,view){const currentData=JSON.parse(view.state.doc.toString()),errors=draft.validate(currentData,schema);if(0===errors.length)return[];const tree=(0,language_dist.qz)(view.state),locationMap=buildJsonPointerMap(view.state.doc,tree.cursor()),duplicateProperties=jsonLintPropertyDuplicates(view.state.doc,tree.cursor()),validationErrors=errors.map((error=>{let flagPropertyNameOnly=!1,flagPropertyValueOnly=!0,pointer=error.data?.pointer;"no-additional-properties-error"===error.code?(pointer=jsonPointer_default().join(error.data?.pointer,error.data?.property),flagPropertyNameOnly=!0):"min-length-error"===error.code&&(flagPropertyValueOnly=!0);const propertyLocation=locationMap[pointer];if(null==propertyLocation)return console.warn("Failed resolving node",propertyLocation),{from:0,to:0,severity:"error",message:error.message};let from=propertyLocation.from,to=propertyLocation.to;if(flagPropertyNameOnly){const propertyNameCursor=getPropertyNameCursor(propertyLocation.node);propertyNameCursor&&(from=propertyNameCursor.from,to=propertyNameCursor.to)}else if(flagPropertyValueOnly){const propertyValueCursor=function getPropertyValueCursor(node){const cursor=getPropertyNameCursor(node);if(cursor)return cursor.nextSibling(),cursor}(propertyLocation.node);propertyValueCursor&&(from=propertyValueCursor.from,to=propertyValueCursor.to)}return{from,to,severity:"error",message:error.message}}));duplicateProperties.length>0&&validationErrors.push(...duplicateProperties);return validationErrors.filter((err=>null!=err))}(draft,localSchema,view)}}var view_dist=__webpack_require__("./node_modules/@codemirror/view/dist/index.js");const jsonSchemaTooltip_dom=document.createElement("div"),jsonSchemaTooltip_root=(0,client.s)(jsonSchemaTooltip_dom);const jsonSchemaTooltip=(editor,nodePointer="#",localSchema)=>(0,view_dist.bF)((async(view,pos,side)=>{const{pointer,cursor,location}=getJsonPointerFromPosition(view.state,pos),absolutePointer=localSchema?`#${pointer}`:`${nodePointer}${pointer}`,data=function jsonSchemaTooltip_getData(doc){try{return JSON.parse(doc.toString())}catch(e){return}}(view.state.doc),schema=editor.draft.getSchema({pointer:`${absolutePointer}`,data,schema:localSchema});return null==schema||"error"===schema.type||"value"===location||null==schema.title&&null==schema.description?null:{pos:cursor.from,end:cursor.to,above:!0,create:view=>(jsonSchemaTooltip_root.render((0,jsx_runtime.jsxs)("div",{className:"rje-code-tooltip rje-code-tooltip--jsonschema",children:[schema.title&&(0,jsx_runtime.jsx)("h1",{children:schema.title}),schema.description&&(0,jsx_runtime.jsx)(index_modern.ZP,{children:schema.description})]})),{dom:jsonSchemaTooltip_dom})}}));var lint_dist=__webpack_require__("./node_modules/@codemirror/lint/dist/index.js"),useCodeMirrorOnBlur=__webpack_require__("./packages/rje-code-widgets/src/lib/useCodeMirrorOnBlur.ts");const InvalidJsonError={type:"error",name:"InvalidJsonError",code:"invalid-json-error",message:"Invalid json format. Changes will be applied only if the json is valid.",data:{pointer:"#",schema:{},value:{}}},JsonWidget=props=>"string"===props.node.schema.type?(0,jsx_runtime.jsx)(JsonStringWidget,{...props}):(0,jsx_runtime.jsx)(JsonDataWidget,{...props}),JsonDataWidget=(0,src.Zg)((({node,options,editor,setValue})=>{const[validJson,setJsonValid]=(0,react.useState)(!0),onChange=(0,react.useCallback)((value=>{try{setValue(JSON.parse(value)),setJsonValid(!0)}catch(e){console.log("failed parsing (jsondata) value",value),setJsonValid(!1)}}),[setValue]),[ref]=(0,useCodeMirrorOnBlur.P)(onChange,node.pointer),onChangeListener={};onChangeListener.ref=ref;const extensions=[(0,dist.AV)(),dist.bA.data.of({autocomplete:jsonSchemaCompletion(editor.draft,node.schema)}),(0,lint_dist.Q2)(),(0,lint_dist.ir)(jsonSchemaLinter(editor,node.schema||{})),jsonSchemaTooltip(editor,node.pointer)];return(0,jsx_runtime.jsxs)(src.$L.Field,{widgetType:"json",node,options,additionalError:validJson?void 0:InvalidJsonError,showDescription:!1,children:[(0,jsx_runtime.jsx)(src.__,{children:options.title}),(0,jsx_runtime.jsx)(esm.ZP,{value:JSON.stringify((0,src.Yu)(node),null,2),basicSetup:options.setup,editable:!1===options.disabled,extensions,height:options.height,minHeight:options.minHeight,maxHeight:options.maxHeight,indentWithTab:options.indentWithTab,placeholder:options.placeholder,readOnly:options.readOnly,theme:options.theme??"light",...onChangeListener,style:{border:"1px solid silver"}}),options.description&&(0,jsx_runtime.jsx)(src.$L.Description,{children:(0,jsx_runtime.jsx)(index_modern.ZP,{children:options.description})})]})})),JsonStringWidget=(0,src.Zg)((({node,options,editor,setValue})=>{const[validJson,setJsonValid]=(0,react.useState)(!0),onChange=(0,react.useCallback)((value=>{try{JSON.parse(value),setValue(value),setJsonValid(!0)}catch(e){console.log("failed parsing (jsonstring) value",value),setJsonValid(!1)}}),[setValue]),tooltip=(0,react.useMemo)((()=>jsonSchemaTooltip(editor,node.pointer,options.schema)),[]),extensions=[(0,dist.AV)(),(0,lint_dist.Q2)(),(0,lint_dist.ir)(jsonSchemaLinter(editor,options.schema||{}))];options.schema&&extensions.push(tooltip,dist.bA.data.of({autocomplete:jsonSchemaCompletion(editor.draft,options.schema)}));const[ref]=(0,useCodeMirrorOnBlur.P)(onChange,node.pointer),onChangeListener={};return options.liveUpdate?onChangeListener.onChange=onChange:onChangeListener.ref=ref,(0,jsx_runtime.jsxs)(src.$L.Field,{widgetType:"json",node,options,additionalError:validJson?void 0:InvalidJsonError,showDescription:!1,children:[(0,jsx_runtime.jsx)(src.__,{children:options.title}),(0,jsx_runtime.jsx)(esm.ZP,{value:node.value,basicSetup:options.setup,editable:!1===options.disabled,extensions,height:options.height,minHeight:options.minHeight,maxHeight:options.maxHeight,indentWithTab:options.indentWithTab,placeholder:options.placeholder,readOnly:options.readOnly,theme:options.theme??"light",...onChangeListener,style:{border:"1px solid silver"}}),options.description&&(0,jsx_runtime.jsx)(src.$L.Description,{children:(0,jsx_runtime.jsx)(index_modern.ZP,{children:options.description})})]})})),JsonWidgetPlugin={id:"json-widget",use:({schema},options)=>"json"===options?.widget||"json"===schema.format,Widget:JsonWidget};try{JsonWidget.displayName="JsonWidget",JsonWidget.__docgenInfo={description:"",displayName:"JsonWidget",props:{}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["packages/rje-code-widgets/src/lib/jsonwidget/JsonWidget.tsx#JsonWidget"]={docgenInfo:JsonWidget.__docgenInfo,name:"JsonWidget",path:"packages/rje-code-widgets/src/lib/jsonwidget/JsonWidget.tsx#JsonWidget"})}catch(__react_docgen_typescript_loader_error){}try{JsonDataWidget.displayName="JsonDataWidget",JsonDataWidget.__docgenInfo={description:"",displayName:"JsonDataWidget",props:{node:{defaultValue:null,description:"",name:"node",required:!0,type:{name:"ParentNode<JsonWidgetOptions>"}},editor:{defaultValue:null,description:"",name:"editor",required:!0,type:{name:"Editor<unknown>"}},options:{defaultValue:null,description:"",name:"options",required:!1,type:{name:"Partial<JsonWidgetOptions>"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["packages/rje-code-widgets/src/lib/jsonwidget/JsonWidget.tsx#JsonDataWidget"]={docgenInfo:JsonDataWidget.__docgenInfo,name:"JsonDataWidget",path:"packages/rje-code-widgets/src/lib/jsonwidget/JsonWidget.tsx#JsonDataWidget"})}catch(__react_docgen_typescript_loader_error){}try{JsonStringWidget.displayName="JsonStringWidget",JsonStringWidget.__docgenInfo={description:"",displayName:"JsonStringWidget",props:{node:{defaultValue:null,description:"",name:"node",required:!0,type:{name:"StringNode<JsonWidgetOptions>"}},editor:{defaultValue:null,description:"",name:"editor",required:!0,type:{name:"Editor<unknown>"}},options:{defaultValue:null,description:"",name:"options",required:!1,type:{name:"Partial<JsonWidgetOptions>"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["packages/rje-code-widgets/src/lib/jsonwidget/JsonWidget.tsx#JsonStringWidget"]={docgenInfo:JsonStringWidget.__docgenInfo,name:"JsonStringWidget",path:"packages/rje-code-widgets/src/lib/jsonwidget/JsonWidget.tsx#JsonStringWidget"})}catch(__react_docgen_typescript_loader_error){}},"./packages/rje-code-widgets/src/lib/useCodeMirrorOnBlur.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{P:()=>useCodeMirrorOnBlur});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/react/index.js");function useCodeMirrorOnBlur(onBlur,pointer){const[codeMirror,setCodeMirror]=(0,react__WEBPACK_IMPORTED_MODULE_0__.useState)(),ref=(0,react__WEBPACK_IMPORTED_MODULE_0__.useCallback)((editor=>{null!=editor&&setCodeMirror(editor)}),[]);return(0,react__WEBPACK_IMPORTED_MODULE_0__.useEffect)((()=>{const contentDOM=codeMirror?.view?.contentDOM;if(null==contentDOM||null==onBlur)return;const valueFromEvent=event=>{if(null==onBlur)return;const contents=codeMirror?.view?.state.doc.toString();contents&&onBlur(contents)};return contentDOM.addEventListener("blur",valueFromEvent),function(){contentDOM?.removeEventListener("blur",valueFromEvent)}}),[codeMirror,onBlur]),[ref]}}}]);